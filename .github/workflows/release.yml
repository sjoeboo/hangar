name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Verify version matches tag
        run: |
          # Extract version from tag (e.g., v0.8.71 -> 0.8.71)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          # Extract version from code
          CODE_VERSION=$(grep -oP 'const Version = "\K[^"]+' cmd/agent-deck/main.go)

          echo "Tag version: $TAG_VERSION"
          echo "Code version: $CODE_VERSION"

          if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
            echo "::error::Version mismatch! Tag is v$TAG_VERSION but code has Version = \"$CODE_VERSION\""
            echo "::error::Please update const Version in cmd/agent-deck/main.go to match the tag."
            exit 1
          fi

          echo "âœ“ Version verified: $CODE_VERSION"

      - name: Run tests
        run: go test -v ./...

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
